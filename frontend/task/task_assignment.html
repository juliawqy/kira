<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Task Manager – Vanilla E2E Tester (Light + Assignees)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root {
    /* ------- Light theme palette ------- */
    --bg: #f7f9fc;
    --panel: #ffffff;
    --muted: #f1f5f9;
    --border: #d4dbe7;
    --text: #0f172a;
    --sub: #475569;
    --accent: #1d4ed8;    /* blue-700 */
    --accent-2: #16a34a;  /* green-600 */
    --warn: #d97706;      /* amber-600 */
    --danger: #dc2626;    /* red-600 */
  }
  * { box-sizing: border-box; }
  body {
    margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial;
    background: linear-gradient(180deg, var(--bg) 0%, #eef2f7 100%);
    color: var(--text);
  }
  a { color: var(--accent); }
  .wrap { max-width: 1100px; margin: 0 auto; padding: 28px 16px 80px; }
  h1 { margin: 0 0 18px; font-size: 22px; }
  .row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
  .panel {
    background: linear-gradient(360deg, rgba(255,255,255,0.96), rgba(255,255,255,0.98));
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 16px;
    box-shadow: 0 1px 2px rgba(2,6,23,0.08);
  }
  .panel h2 { margin: 0 0 12px; font-size: 16px; color: var(--sub); font-weight: 600;}
  input, select, textarea {
    background: var(--muted);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 10px;
    outline: none;
  }
  textarea { resize: vertical; min-height: 70px; }
  label { display: block; font-size: 12px; color: var(--sub); margin-bottom: 6px; }
  .grid { display: grid; gap: 12px; }
  .grid.two { grid-template-columns: repeat(2, minmax(0,1fr)); }
  .grid.three { grid-template-columns: repeat(3, minmax(0,1fr)); }
  .btn {
    border: 1px solid var(--border);
    background: #e7eefb;
    color: var(--text); padding: 8px 12px; border-radius: 8px; cursor: pointer;
  }
  .btn:hover { background: #dce6fb; }
  .btn.primary { background: #dbe7ff; border-color: #c8d8ff; }
  .btn.primary:hover { background: #cfe0ff; }
  .btn.success { background: #dcfce7; border-color: #b7f7cc; }
  .btn.success:hover { background: #ccf7db; }
  .btn.warn { background: #fef3c7; border-color: #fde68a; }
  .btn.warn:hover { background: #fde9a4; }
  .btn.danger { background: #fee2e2; border-color: #fecaca; }
  .btn.danger:hover { background: #ffd9d9; }
  .btn.ghost { background: transparent; }
  .tag { font-size: 12px; padding: 2px 6px; border: 1px solid var(--border); border-radius: 999px; color: var(--sub); }
  .task { padding: 12px; border: 1px solid var(--border); border-radius: 12px; background: rgba(255,255,255,0.9); }
  .muted { color: var(--sub); }
  .hr { height: 1px; background: var(--border); margin: 10px 0; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  .console { max-height: 250px; overflow: auto; background: #fafafa; border-radius: 10px; padding: 10px; border: 1px solid var(--border); }
  .subtasks { background: #f7fafc; border-radius: 10px; padding: 10px; border: 1px dashed var(--border); }
  .row-right { margin-left: auto; display: inline-flex; gap: 8px; align-items: center; }
  .pill { font-size: 12px; padding: 2px 8px; border-radius: 999px; border: 1px solid var(--border); }
  .pill.ok { border-color: #16a34a; color: #065f46; background: #ecfdf5; }
  .pill.bad { border-color: #d97706; color: #92400e; background: #fffbeb; }
  .small { font-size: 12px; }
  .flex { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  .w-100 { width: 100%; }
  .sr { display: none; }
  @media (max-width: 860px) { .grid.two, .grid.three { grid-template-columns: 1fr; } }
</style>
</head>
<body>
<div class="wrap">
  <h1>Task Manager – Vanilla E2E (Light)</h1>

  <!-- Controls -->
  <div class="panel">
    <div class="row">
      <div class="grid" style="min-width: 280px; flex: 1">
        <label for="baseUrl">Task API Base URL</label>
        <input id="baseUrl" placeholder="http://localhost:8000/kira/app/api/v1/task" />
      </div>
      <div class="grid" style="min-width: 280px; flex: 1">
        <label for="userBaseUrl">User API Base URL</label>
        <input id="userBaseUrl" placeholder="http://localhost:8000/kira/app/api/v1/user" />
      </div>
      <button class="btn" id="btnLoad" type="button">Load Parents</button>
      <span class="muted small">Users are read from <span class="mono">/user</span>; assignments post to <span class="mono">/task/{id}/assignees</span>.</span>
    </div>
  </div>

  <!-- Create -->
  <div class="panel" style="margin-top: 12px;">
    <h2>Create Task</h2>
    <div class="grid three">
      <div>
        <label>Title</label>
        <input id="c_title" />
      </div>
      <div>
        <label>Description</label>
        <input id="c_desc" />
      </div>
      <div>
        <label>Priority (1–10)</label>
        <input id="c_priority" type="number" min="1" max="10" value="5" />
      </div>
      <div>
        <label>Status</label>
        <select id="c_status">
          <option selected>To-do</option><option>In-progress</option><option>Blocked</option><option>Completed</option>
        </select>
      </div>
      <div>
        <label>Start date (YYYY-MM-DD)</label>
        <input id="c_start" placeholder="optional" />
      </div>
      <div>
        <label>Deadline (YYYY-MM-DD)</label>
        <input id="c_due" placeholder="optional" />
      </div>
      <div>
        <label>Project ID (required)</label>
        <input id="c_project" type="number" />
      </div>
      <div>
        <label>Active</label>
        <select id="c_active"><option value="true" selected>true</option><option value="false">false</option></select>
      </div>
      <div>
        <label>Parent ID (create as subtask)</label>
        <input id="c_parent" type="number" placeholder="optional" />
      </div>
      <div>
        <label>Tag</label>
        <input id="c_tag" placeholder="optional" />
      </div>
      <div>
        <label>Recurring (times)</label>
        <input id="c_recurring" type="number" min="0" value="0" />
      </div>
    </div>
    <div class="row" style="margin-top: 10px;">
      <button class="btn primary" id="btnCreate" type="button">Create</button>
    </div>
  </div>

  <!-- Parents list -->
  <div class="panel" style="margin-top: 12px;">
    <h2>Parents (Top-level tasks)</h2>
    <div id="parents"></div>
  </div>

  <!-- Console -->
  <div class="panel" style="margin-top: 12px;">
    <h2>Console</h2>
    <div id="log" class="console mono small"></div>
  </div>

  <!-- Edit dialog -->
  <dialog id="dlgEdit">
    <form method="dialog" class="panel" style="min-width: 600px; background: var(--panel);">
      <h2>Edit Task</h2>
      <div class="grid three">
        <div><label>Title</label><input id="e_title" /></div>
        <div><label>Description</label><input id="e_desc" /></div>
        <div>
          <label>Priority (1–10)</label>
          <input id="e_priority" type="number" min="1" max="10" />
        </div>
        <div><label>Start date</label><input id="e_start" placeholder="YYYY-MM-DD"/></div>
        <div><label>Deadline</label><input id="e_due" placeholder="YYYY-MM-DD"/></div>
        <div><label>Project ID</label><input id="e_project" type="number"/></div>
        <div><label>Active</label>
          <select id="e_active"><option value="true">true</option><option value="false">false</option></select>
        </div>
        <div><label>Tag</label><input id="e_tag" /></div>
        <div>
          <label>Recurring (times)</label>
          <input id="e_recurring" type="number" min="0"/>
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <div class="muted small" id="e_hint"></div>
        <span class="row-right">
          <button class="btn" value="cancel">Cancel</button>
          <button class="btn success" id="btnSaveEdit" value="default">Save</button>
        </span>
      </div>
    </form>
  </dialog>

</div>

<script>
(function () {
  // -------------------- Configuration / State --------------------
  const LS_KEY_TASK = "task_demo_base";
  const LS_KEY_USER = "task_demo_user_base";
  const baseInput = document.getElementById("baseUrl");
  const userBaseInput = document.getElementById("userBaseUrl");
  baseInput.value = localStorage.getItem(LS_KEY_TASK) || "http://localhost:8000/kira/app/api/v1/task";
  userBaseInput.value = localStorage.getItem(LS_KEY_USER) || inferUserBase(baseInput.value);
  baseInput.addEventListener("change", () => {
    localStorage.setItem(LS_KEY_TASK, baseInput.value.trim());
    if (!localStorage.getItem(LS_KEY_USER)) userBaseInput.value = inferUserBase(baseInput.value);
  });
  userBaseInput.addEventListener("change", () => localStorage.setItem(LS_KEY_USER, userBaseInput.value.trim()));

  const parentsEl = document.getElementById("parents");
  const logEl = document.getElementById("log");

  // Edit dialog refs
  const dlgEdit = document.getElementById("dlgEdit");
  const e_title = document.getElementById("e_title");
  const e_desc = document.getElementById("e_desc");
  const e_priority = document.getElementById("e_priority");
  const e_start = document.getElementById("e_start");
  const e_due = document.getElementById("e_due");
  const e_project = document.getElementById("e_project");
  const e_active = document.getElementById("e_active");
  const e_tag = document.getElementById("e_tag");
  const e_recurring = document.getElementById("e_recurring");
  const e_hint = document.getElementById("e_hint");
  let editingTaskId = null;

  // Create form refs
  const c_title = document.getElementById("c_title");
  const c_desc = document.getElementById("c_desc");
  const c_priority = document.getElementById("c_priority");
  const c_status = document.getElementById("c_status");
  const c_start = document.getElementById("c_start");
  const c_due = document.getElementById("c_due");
  const c_project = document.getElementById("c_project");
  const c_active = document.getElementById("c_active");
  const c_parent = document.getElementById("c_parent");
  const c_tag = document.getElementById("c_tag");
  const c_recurring = document.getElementById("c_recurring");

  // Users cache
  let USERS = [];

  // -------------------- Helpers --------------------
  function inferUserBase(taskBase) {
    const trimmed = (taskBase || '').replace(/\/$/, '');
    if (trimmed.endsWith('/task')) return trimmed.replace(/\/task$/, '/user');
    return 'http://localhost:8000/kira/app/api/v1/user';
  }

  function log(label, payload) {
    const line = `[${new Date().toLocaleTimeString()}] ${label}: ${typeof payload === "string" ? payload : JSON.stringify(payload, null, 2)}`;
    const div = document.createElement("div");
    div.textContent = line;
    logEl.prepend(div);
  }

  async function api(path, init) {
    const url = baseInput.value.replace(/\/$/, "") + path;
    const res = await fetch(url, {
      headers: { "Content-Type": "application/json" },
      ...init,
    });
    if (!res.ok) {
      let detail = "";
      try { detail = await res.text(); } catch {}
      throw new Error(`${res.status} ${res.statusText} - ${detail}`);
    }
    if (res.status === 204) return null;
    return res.json();
  }

  async function apiUsers(path, init) {
    const url = userBaseInput.value.replace(/\/$/, "") + path;
    const res = await fetch(url, { headers: { "Content-Type": "application/json" }, ...init });
    if (!res.ok) {
      let detail = "";
      try { detail = await res.text(); } catch {}
      throw new Error(`${res.status} ${res.statusText} - ${detail}`);
    }
    if (res.status === 204) return null;
    return res.json();
  }

  function field(labelText, valueText) {
    const span = document.createElement("span");
    span.className = "muted small";
    span.innerHTML = `<strong class="muted">${labelText}:</strong> ${valueText}`;
    return span;
  }

  function getPriorityDisplay(task) {
    if (typeof task.priority === "number") return String(task.priority);
    if (typeof task.priority === "string") return task.priority;
    return "—";
  }

  function getSubtasks(task) { return task.subTasks || task.subtasks || []; }
  function getAssignees(task) { return task.assignees || task.users || []; }

  // Debounced auto-reload of the parents list after any action
  let _reloadTimer = null;
  function autoReload(delay = 80) { clearTimeout(_reloadTimer); _reloadTimer = setTimeout(() => loadParents(), delay); }

  // -------------------- Render --------------------
  async function loadParents() {
    parentsEl.innerHTML = `<div class="muted">Loading…</div>`;
    try {
      await loadUsers();
      const data = await api("/", { method: "GET" }); // List parents with subTasks
      renderParents(Array.isArray(data) ? data : []);
      log("GET /", data);
    } catch (e) {
      parentsEl.innerHTML = "";
      log("GET / error", String(e));
      alert("Failed to load parents:" + e.message);
    }
  }

  async function loadUsers() {
    try {
      const data = await apiUsers("/", { method: "GET" });
      USERS = Array.isArray(data) ? data : (data.items || []);
      log("GET /user/", USERS);
    } catch (e) {
      USERS = [];
      log("GET users error", String(e));
    }
  }

  async function loadAssigneesForTask(taskId) {
    try {
      return await api(`/${taskId}/assignees`, { method: "GET" });
    } catch (e) {
      log("GET assignees error", String(e));
      return [];
    }
  }

  function renderParents(list) {
    parentsEl.innerHTML = "";
    if (list.length === 0) {
      parentsEl.innerHTML = `<div class="muted">No data. Click “Load Parents”.</div>`;
      return;
    }
    list.forEach(t => parentsEl.appendChild(renderTaskCard(t)));
  }

  function renderTaskCard(task) {
    const el = document.createElement("div");
    el.className = "task";
    el.dataset.id = task.id;

    // Header row with basic info + actions
    const row1 = document.createElement("div");
    row1.className = "flex";
    const title = document.createElement("div");
    title.innerHTML = `<strong>#${task.id}</strong> &nbsp; ${escapeHtml(task.title)}`;
    row1.appendChild(title);

    row1.appendChild(field("Status", task.status));
    row1.appendChild(field("Priority", getPriorityDisplay(task)));
    row1.appendChild(field("Active", String(task.active)));
    if (typeof task.recurring === "number") row1.appendChild(field("Recurring", String(task.recurring)));
    if (task.tag) row1.appendChild(field("Tag", escapeHtml(task.tag)));
    if (task.deadline) row1.appendChild(field("Due", task.deadline));
    if (task.project_id != null) row1.appendChild(field("Project", task.project_id));

    const actionRow = document.createElement("div");
    actionRow.className = "row-right";
    actionRow.appendChild(btn("Start", "btn", () => setStatus(task.id, "start")));
    actionRow.appendChild(btn("Block", "btn warn", () => setStatus(task.id, "block")));
    actionRow.appendChild(btn("Complete", "btn success", () => setStatus(task.id, "complete")));
    actionRow.appendChild(btn("Delete", "btn", () => deleteTask(task.id)));
    actionRow.appendChild(btn("Edit", "btn primary", () => openEdit(task)));
    row1.appendChild(actionRow);
    el.appendChild(row1);

    // Description / notes row
    const row2 = document.createElement("div");
    row2.className = "muted small";
    row2.style.marginTop = "6px";
    row2.textContent = task.description || "(no description)";
    el.appendChild(row2);

    // Assignee controls (Task)
    el.appendChild(renderAssigneeControls(task.id, getAssignees(task)));

    // Attach subtask form
    const rowAttach = document.createElement("div");
    rowAttach.className = "row";
    rowAttach.style.marginTop = "10px";
    const attachInput = document.createElement("input");
    attachInput.placeholder = "Attach subtask IDs (comma-separated)";
    attachInput.style.minWidth = "260px";
    rowAttach.appendChild(attachInput);
    rowAttach.appendChild(btn("Attach", "btn", async () => {
      const ids = attachInput.value.split(",").map(s => Number(s.trim())).filter(n => !Number.isNaN(n));
      try {
        const res = await api(`/${task.id}/subtasks`, { method: "POST", body: JSON.stringify({ subtask_ids: ids }) });
        log(`POST /${task.id}/subtasks`, res);
        autoReload();
      } catch (e) { log("Attach error", String(e)); alert(e.message); }
    }));
    const subWrap = document.createElement("div");
    const btnToggle = btn("Toggle subtasks", "btn ghost", () => { subWrap.classList.toggle("sr"); });
    rowAttach.appendChild(btnToggle);
    el.appendChild(rowAttach);

    // Subtasks area
    subWrap.className = "subtasks";
    subWrap.style.marginTop = "8px";
    const subs = getSubtasks(task);
    if (Array.isArray(subs) && subs.length > 0) { subs.forEach(st => subWrap.appendChild(renderSubtaskRow(task.id, st))); }
    else { const none = document.createElement("div"); none.className = "muted small"; none.textContent = "No subtasks."; subWrap.appendChild(none); }
    el.appendChild(subWrap);

    return el;
  }

  // Assignee controls component (task or subtask)
  function renderAssigneeControls(entityId, initialAssignees) {
    const assWrap = document.createElement("div");
    assWrap.className = "row";
    assWrap.style.marginTop = "10px";

    const assSelect = document.createElement("select");
    assSelect.multiple = true;
    assSelect.size = Math.min(6, Math.max(3, USERS.length));
    assSelect.style.minWidth = "260px";

    const current = initialAssignees || [];
    const assignedIds = new Set(current.map(a => String(a.user_id ?? a.id)));

    USERS.forEach(u => {
      const opt = document.createElement("option");
      opt.value = String(u.user_id ?? u.id);
      opt.textContent = u.name || u.full_name || u.email || `user ${opt.value}`;
      if (assignedIds.has(opt.value)) opt.selected = true;
      assSelect.appendChild(opt);
    });

    assWrap.appendChild(assSelect);
    assWrap.appendChild(btn("Assign selected", "btn", async () => {
      const ids = Array.from(assSelect.selectedOptions).map(o => Number(o.value));
      try {
        const res = await api(`/${entityId}/assignees`, { method: "POST", body: JSON.stringify({ user_ids: ids }) });
        log(`POST /${entityId}/assignees`, res);
        autoReload();
      } catch (e) { log("Assign error", String(e)); alert(e.message); }
    }));
    assWrap.appendChild(btn("Clear all", "btn danger", async () => {
      try {
        const res = await api(`/${entityId}/assignees/all`, { method: "DELETE" });
        log(`DELETE /${entityId}/assignees/all`, res);
        autoReload();
      } catch (e) { log("Clear all error", String(e)); alert(e.message); }
    }));

    const currentEl = document.createElement("div");
    currentEl.className = "flex";
    const renderAssignees = (list) => {
      currentEl.innerHTML = "";
      if (!list || list.length === 0) {
        const none = document.createElement("span");
        none.className = "muted small";
        none.textContent = "No assignees yet.";
        currentEl.appendChild(none);
        return;
      }
      list.forEach(a => {
        const chip = document.createElement("span");
        chip.className = "pill";
        chip.textContent = a.name || a.full_name || a.email || `user ${a.user_id ?? a.id}`;
        const remove = document.createElement("button");
        remove.className = "btn danger small";
        remove.style.marginLeft = "6px";
        remove.textContent = "Remove";
        remove.addEventListener("click", async (e) => {
          e.preventDefault();
          try {
            const body = JSON.stringify({ user_ids: [Number(a.user_id ?? a.id)] });
            await api(`/${entityId}/assignees`, { method: "DELETE", body });
            log(`DELETE /${entityId}/assignees`, body);
            autoReload();
          } catch (err) { log("Unassign error", String(err)); alert(err.message); }
        });
        const wrap = document.createElement("span");
        wrap.className = "flex";
        wrap.appendChild(chip); wrap.appendChild(remove);
        currentEl.appendChild(wrap);
      });
    };

    if (current.length > 0) {
      renderAssignees(current);
    } else {
      loadAssigneesForTask(entityId).then(list => renderAssignees(list || []));
    }

    const assBlock = document.createElement("div");
    assBlock.className = "w-100";
    const lbl = document.createElement("label");
    lbl.className = "muted small";
    lbl.textContent = "Assignees";
    assBlock.appendChild(lbl);
    assBlock.appendChild(currentEl);

    assWrap.appendChild(assBlock);
    return assWrap;
  }

  function renderSubtaskRow(parentId, st) {
    const row = document.createElement("div");
    row.className = "flex";
    row.style.flexDirection = "column";
    row.style.gap = "8px";
    row.style.padding = "6px 0";

    // top line
    const top = document.createElement("div");
    top.className = "flex";
    top.style.justifyContent = "space-between";
    top.style.alignItems = "center";

    const left = document.createElement("div");
    const bits = [
      `<strong>#${st.id}</strong>`,
      escapeHtml(st.title),
      `<span class="muted small">${st.status}</span>`,
      `<span class="muted small">Active: ${String(st.active)}</span>`
    ];
    if (typeof st.recurring === "number") bits.push(`<span class="muted small">Recurring: ${st.recurring}</span>`);
    if (st.tag) bits.push(`<span class="muted small">Tag: ${escapeHtml(st.tag)}</span>`);
    if (st.deadline) bits.push(`<span class="muted small">Due: ${st.deadline}</span>`);
    left.innerHTML = bits.join(" &nbsp; ");
    top.appendChild(left);

    const right = document.createElement("div");
    right.className = "row-right";
    right.appendChild(btn("Start", "btn", async () => { try { await setStatus(st.id, "start"); } catch (e) { alert(e.message);} }));
    right.appendChild(btn("Block", "btn warn", async () => { try { await setStatus(st.id, "block"); } catch (e) { alert(e.message);} }));
    right.appendChild(btn("Complete", "btn success", async () => { try { await setStatus(st.id, "complete"); } catch (e) { alert(e.message);} }));
    right.appendChild(btn("Delete", "btn", async () => {
      try {
        const res = await api(`/${st.id}/delete`, { method: "POST" });
        log(`POST /${st.id}/delete`, res);
        autoReload();
      } catch (e) { log("Subtask delete error", String(e)); alert(e.message); }
    }));
    right.appendChild(btn("Edit", "btn primary", () => { openEdit(st); }));
    right.appendChild(btn("Detach", "btn danger", async () => {
      try {
        const res = await api(`/${parentId}/subtasks/${st.id}`, { method: "DELETE" });
        log(`DELETE /${parentId}/subtasks/${st.id}`, res);
        autoReload();
      } catch (e) { log("Detach error", String(e)); alert(e.message); }
    }));
    top.appendChild(right);
    row.appendChild(top);

    // Assignee controls (Subtask)
    row.appendChild(renderAssigneeControls(st.id, getAssignees(st)));

    return row;
  }

  function btn(label, cls, onClick) {
    const b = document.createElement("button");
    b.type = "button";
    b.className = cls + " small";
    b.textContent = label;
    b.addEventListener("click", (e) => { e.preventDefault(); onClick && onClick(); });
    return b;
  }

  // -------------------- Actions --------------------
  function mapActionToStatus(action) {
    switch (action) {
      case "start": return "In-progress";
      case "block": return "Blocked";
      case "complete": return "Completed";
      default: return "To-do";
    }
  }

  async function setStatus(id, action) {
    const newStatus = mapActionToStatus(action);
    try { const res = await api(`/${id}/status/${encodeURIComponent(newStatus)}`, { method: "POST" }); log(`POST /${id}/status/${newStatus}`, res); autoReload(); }
    catch (e) { log("Status error", String(e)); alert(e.message); }
  }

  async function deleteTask(id) {
    try {
      const res = await api(`/${id}/delete`, { method: "POST" });
      log(`POST /${id}/delete`, res);
      autoReload();
    } catch (e) {
      log("Delete error", String(e));
      alert(e.message);
    }
  }

  function openEdit(task) {
    editingTaskId = task.id;
    e_title.value = task.title || "";
    e_desc.value = task.description || "";
    e_priority.value = (typeof task.priority === "number" ? task.priority : "") || "";
    e_start.value = task.start_date || "";
    e_due.value = task.deadline || "";
    e_project.value = task.project_id ?? "";
    e_active.value = task.active ? "true" : "false";
    e_tag.value = task.tag || "";
    e_recurring.value = (typeof task.recurring === "number" ? task.recurring : "") || "";
    e_hint.textContent = `Editing #${task.id} (status updates are separate actions)`;
    dlgEdit.showModal();
  }

  document.getElementById("btnSaveEdit").addEventListener("click", async (ev) => {
    ev.preventDefault();
    if (!editingTaskId) return;
    const payload = {};
    if (e_title.value !== "") payload.title = e_title.value;
    if (e_desc.value !== "") payload.description = e_desc.value;
    if (e_priority.value !== "") payload.priority = Number(e_priority.value);
    if (e_start.value !== "") payload.start_date = e_start.value || null;
    if (e_due.value !== "") payload.deadline = e_due.value || null;
    if (e_project.value !== "") payload.project_id = Number(e_project.value);
    if (e_tag.value !== "") payload.tag = e_tag.value;
    if (e_recurring.value !== "") payload.recurring = Number(e_recurring.value);
    payload.active = e_active.value === "true";

    try {
      const res = await api(`/${editingTaskId}`, { method: "PATCH", body: JSON.stringify(payload) });
      log(`PATCH /${editingTaskId}`, res);
      dlgEdit.close();
      autoReload();
    } catch (e) { log("PATCH error", String(e)); alert(e.message); }
  });

  // Create task
  document.getElementById("btnCreate").addEventListener("click", async () => {
    const pb = Number(c_priority.value);
    const proj = c_project.value === "" ? null : Number(c_project.value);
    if (proj == null || Number.isNaN(proj)) {
      alert("Project ID is required.");
      return;
    }
    const rec = c_recurring.value === "" ? 0 : Number(c_recurring.value);
    const payload = {
      title: c_title.value || "",
      description: c_desc.value || null,
      start_date: c_start.value || null,
      deadline: c_due.value || null,
      priority: Number.isNaN(pb) ? 5 : Math.min(10, Math.max(1, pb)),
      status: c_status.value,
      project_id: proj,                     // required
      active: c_active.value === "true",
      parent_id: c_parent.value === "" ? null : Number(c_parent.value),
      tag: c_tag.value || null,
      recurring: Number.isNaN(rec) ? 0 : rec
    };
    try {
      const res = await api("/", { method: "POST", body: JSON.stringify(payload) });
      log("POST /", res);
      c_title.value = ""; c_desc.value = ""; c_start.value = ""; c_due.value = "";
      c_project.value = ""; c_parent.value = ""; c_tag.value = ""; c_recurring.value = "0";
      autoReload();
    } catch (e) { log("Create error", String(e)); alert(e.message); }
  });

  // Load parents button
  document.getElementById("btnLoad").addEventListener("click", loadParents);

  // Utilities
  function escapeHtml(s) { return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

  // First load (optional)
  loadParents();
})();
</script>
</body>
</html>
