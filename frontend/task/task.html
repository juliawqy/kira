<!DOCTYPE html>
<html>
<head>
  <title>Tasks</title>
  <script>
    const params = new URLSearchParams(location.search);
    const API_BASE = params.get('api') || "http://127.0.0.1:8000/kira/app/api/v1/task";

    async function refreshTasks() {
      const resp = await fetch(API_BASE + "/");
      const tasks = await resp.json();
      const list = document.getElementById("task-list");
      list.innerHTML = "";
      tasks.forEach(t => {
        const item = document.createElement("div");
        item.className = "task-item";
        item.innerHTML = `
          <div class="task-info" data-id="${t.id}"><strong>${t.title}</strong> <span class="muted">(ID: ${t.id})</span><br/>
            <span class="muted">Status:</span> ${t.status} | <span class="muted">Priority:</span> ${t.priority ?? ''}
          </div>
          <div class="inline-edit">
            <input id="update-title-${t.id}" placeholder="Title" />
            <input id="update-desc-${t.id}" placeholder="Description" />
            <input id="update-priority-${t.id}" type="number" placeholder="Priority" />
            <button class="save-btn" onclick="saveTask(${t.id})">Save</button>
          </div>
          <div class="subtasks">
            <div>
              <input id="attach-input-${t.id}" placeholder="Subtask ID" />
              <button class="attach-btn" onclick="attachSubtask(${t.id})">Attach</button>
            </div>
            <div class="subtask-list" id="subtasks-${t.id}"></div>
          </div>
          <div class="actions">
            <button class="update-btn" onclick="prefillUpdate(${t.id}, '${(t.title||'').replace(/'/g, "\\'")}', '${(t.description||'').replace(/'/g, "\\'")}', ${t.priority||''})">Update</button>
            <!-- Parent delete button now has its own class -->
            <button class="delete-btn parent-delete-btn" onclick="deleteTask(${t.id})">Delete</button>
          </div>
        `;
        list.appendChild(item);
        // Render existing subtasks if present (subTasks key from API)
        const subContainer = document.getElementById(`subtasks-${t.id}`);
        const subs = (t.subTasks || []).map(st => ({ id: st.id, title: st.title }));
        if (subs.length > 0) {
          const ul = document.createElement('ul');
          ul.className = 'subtask-ul';
          subs.forEach(st => {
            const li = document.createElement('li');
            li.className = 'subtask-item';
            li.innerHTML = `
              <div class="subtask-info"><strong>${st.title}</strong> <span class="muted">(ID: ${st.id})</span></div>
              <div class="subtask-inline-edit">
                <input id="update-title-${st.id}" placeholder="Title" />
                <input id="update-desc-${st.id}" placeholder="Description" />
                <input id="update-priority-${st.id}" type="number" placeholder="Priority" />
                <button class="save-btn" onclick="saveTask(${st.id})">Save</button>
                <!-- Subtask delete button stays as plain delete-btn -->
                <button class="delete-btn" onclick="deleteTask(${st.id})">Delete</button>
              </div>
              <div class="subtask-actions">
                <button class="detach-btn" onclick="detachSubtask(${t.id}, ${st.id})">Detach</button>
              </div>
            `;
            ul.appendChild(li);
          });
          subContainer.appendChild(ul);
        }
      });
    }

    async function createTask() {
      const payload = {
        title: document.getElementById("task-title").value,
        description: document.getElementById("task-desc").value,
        priority: parseInt(document.getElementById("task-priority").value),
        status: document.getElementById("task-status").value,
        project_id: parseInt(document.getElementById("task-project").value)
      };
      const resp = await fetch(API_BASE + "/", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
      });
      if (resp.ok) {
        document.getElementById("status-msg").innerText = "task created";
        await refreshTasks();
      }
    }

    function prefillUpdate(id, title, desc, priority) {
      document.getElementById(`update-title-${id}`).value = title || "";
      document.getElementById(`update-desc-${id}`).value = desc || "";
      document.getElementById(`update-priority-${id}`).value = priority || "";
    }

    async function saveTask(id) {
      const payload = {
        title: document.getElementById(`update-title-${id}`).value,
        description: document.getElementById(`update-desc-${id}`).value,
        priority: parseInt(document.getElementById(`update-priority-${id}`).value)
      };
      const resp = await fetch(API_BASE + "/" + id, {
        method: "PATCH",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
      });
      if (resp.ok) {
        document.getElementById("status-msg").innerText = "updated successfully";
        await refreshTasks();
      }
    }

    async function deleteTask(id) {
      const resp = await fetch(API_BASE + "/" + id + "/delete", { method: "POST" });
      if (resp.ok) {
        document.getElementById("status-msg").innerText = "deleted successfully";
        await refreshTasks();
      }
    }

    async function attachSubtask(parentId) {
      const input = document.getElementById(`attach-input-${parentId}`);
      const id = parseInt(input.value);
      const resp = await fetch(API_BASE + "/" + parentId + "/subtasks", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ subtask_ids: [id] })
      });
      if (resp.ok) {
        document.getElementById("status-msg").innerText = "subtask added";
        await refreshTasks();
      }
    }

    async function detachSubtask(parentId, subtaskId) {
      const resp = await fetch(API_BASE + "/" + parentId + "/subtasks/" + subtaskId, { method: "DELETE" });
      if (resp.ok) {
        document.getElementById("status-msg").innerText = "subtask detached";
        await refreshTasks();
      }
    }

    window.onload = refreshTasks;
  </script>
</head>
<body>
  <h1>Task List</h1>
  <div id="create-form">
    <input id="task-title" placeholder="Title" />
    <input id="task-desc" placeholder="Description" />
    <select id="task-priority">
      <option value="" disabled selected>Priority</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="7">7</option>
      <option value="8">8</option>
      <option value="9">9</option>
      <option value="10">10</option>
    </select>
    <select id="task-status">
      <option value="" disabled selected>Status</option>
      <option value="To-do">To-do</option>
      <option value="In-progress">In-progress</option>
      <option value="Completed">Completed</option>
      <option value="Blocked">Blocked</option>
    </select>
    <select id="task-project">
      <option value="" disabled selected>Project</option>
      <option value="1">Project Alpha (1)</option>
      <option value="100">Project Beta (100)</option>
      <option value="123">Project Gamma (123)</option>
    </select>
    <button onclick="createTask()" id="create-task">Submit</button>
  </div>
  <div id="status-msg"></div>
  <button id="refresh-btn" onclick="refreshTasks()">Refresh</button>
  <div id="task-list"></div>
</body>
</html>
