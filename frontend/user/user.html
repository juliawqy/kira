<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Users</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .user-item { 
      border: 1px solid #ccc; 
      margin: 10px 0; 
      padding: 15px; 
      border-radius: 5px;
      background-color: #f9f9f9;
    }
    .user-info { margin-bottom: 10px; font-weight: bold; }
    .user-actions { margin-top: 10px; }
    .update-form { 
      display: none; 
      margin-top: 10px; 
      padding: 10px; 
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 3px;
    }
    .form-group { margin-bottom: 10px; }
    .form-group label { display: inline-block; width: 80px; }
    .form-group input, .form-group select { 
      width: 200px; 
      padding: 5px; 
      margin-left: 10px;
    }
    button { 
      margin-right: 10px; 
      padding: 8px 15px; 
      border: none; 
      border-radius: 3px; 
      cursor: pointer;
    }
    .btn-update { background-color: #007bff; color: white; }
    .btn-delete { background-color: #dc3545; color: white; }
    .btn-save { background-color: #28a745; color: white; }
    .btn-cancel { background-color: #6c757d; color: white; }
    .btn-refresh { background-color: #17a2b8; color: white; }
    .btn-create { background-color: #28a745; color: white; }
    #status { margin-top: 20px; font-weight: bold; }
    .success { color: green; }
    .error { color: red; }
  </style>
</head>
<body>
  <h1>All Users</h1>
  <button id="refresh" class="btn-refresh">Refresh Users</button>
  <button id="createUser" class="btn-create">Create New User</button>
  <div id="userList"></div>
  <p id="status"></p>

  <script>
    // ðŸ”‘ Central API base
    const API_BASE = "http://127.0.0.1:8000/kira/app/api/v1";

    function setStatus(message, isError = false) {
      const statusEl = document.getElementById("status");
      statusEl.innerText = message;
      statusEl.className = isError ? "error" : "success";
    }

    async function loadUsers() {
      try {
        const resp = await fetch(`${API_BASE}/user/`);
        if (!resp.ok) {
          const err = await resp.json();
          throw new Error(err.detail || "Unknown error");
        }

        const users = await resp.json();
        const listEl = document.getElementById("userList");
        listEl.innerHTML = "";
        
        users.forEach(user => {
          const userDiv = document.createElement("div");
          userDiv.className = "user-item";
          userDiv.innerHTML = `
            <div class="user-info" id="user-info-${user.user_id}">
              ID: ${user.user_id} | Name: ${user.name} | Email: ${user.email} | Role: ${user.role}
            </div>
            <div class="user-actions">
              <button class="btn-update" onclick="showUpdateForm(${user.user_id}, '${user.name}', '${user.email}', '${user.role}')">Update</button>
              <button class="btn-delete" onclick="deleteUser(${user.user_id}, '${user.name}')">Delete</button>
            </div>
            <div id="update-form-${user.user_id}" class="update-form">
              <h4>Update User</h4>
              <div class="form-group">
                <label>Name:</label>
                <input type="text" id="update-name-${user.user_id}" value="${user.name}">
              </div>
              <div class="form-group">
                <label>Email:</label>
                <input type="email" id="update-email-${user.user_id}" value="${user.email}">
              </div>
              <div class="form-group">
                <label>Role:</label>
                <select id="update-role-${user.user_id}">
                  <option value="Staff" ${user.role === 'Staff' ? 'selected' : ''}>Staff</option>
                  <option value="Manager" ${user.role === 'Manager' ? 'selected' : ''}>Manager</option>
                  <option value="Director" ${user.role === 'Director' ? 'selected' : ''}>Director</option>
                  <option value="HR" ${user.role === 'HR' ? 'selected' : ''}>HR</option>
                </select>
              </div>
              <button class="btn-save" onclick="updateUser(${user.user_id})">Save Changes</button>
              <button class="btn-cancel" onclick="hideUpdateForm(${user.user_id})">Cancel</button>
            </div>
          `;
          listEl.appendChild(userDiv);
        });
        setStatus("Users loaded successfully");
      } catch (err) {
        setStatus("Error connecting to backend: " + err.message, true);
      }
    }

    function showUpdateForm(userId, name, email, role) {
      // Hide all other update forms
      document.querySelectorAll('.update-form').forEach(form => {
        form.style.display = 'none';
      });
      
      // Show the specific update form
      const form = document.getElementById(`update-form-${userId}`);
      form.style.display = 'block';
    }

    function hideUpdateForm(userId) {
      const form = document.getElementById(`update-form-${userId}`);
      form.style.display = 'none';
    }

    async function updateUser(userId) {
      const name = document.getElementById(`update-name-${userId}`).value.trim();
      const email = document.getElementById(`update-email-${userId}`).value.trim();
      const role = document.getElementById(`update-role-${userId}`).value;

      if (!name || !email) {
        setStatus("Name and email are required", true);
        return;
      }

      try {
        const resp = await fetch(`${API_BASE}/user/${userId}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            name: name,
            email: email,
            role: role
          })
        });

        if (!resp.ok) {
          const err = await resp.json();
          throw new Error(err.detail || "Update failed");
        }

        const updatedUser = await resp.json();
        setStatus(`User ${updatedUser.name} updated successfully`);
        hideUpdateForm(userId);
        loadUsers(); // Refresh the list
      } catch (err) {
        setStatus("Error updating user: " + err.message, true);
      }
    }

    async function deleteUser(userId, userName) {
      if (!confirm(`Are you sure you want to delete user "${userName}"?`)) {
        return;
      }

      try {
        const resp = await fetch(`${API_BASE}/user/${userId}`, {
          method: 'DELETE'
        });

        if (!resp.ok) {
          const err = await resp.json();
          throw new Error(err.detail || "Delete failed");
        }

        setStatus(`User ${userName} deleted successfully`);
        loadUsers(); // Refresh the list
      } catch (err) {
        setStatus("Error deleting user: " + err.message, true);
      }
    }

    document.getElementById("refresh").addEventListener("click", loadUsers);
    
    // Navigate to create user page
    document.getElementById("createUser").addEventListener("click", function() {
      const createUserPath = window.location.href.replace('user.html', 'create_user.html');
      window.location.href = createUserPath;
    });

    // Auto-load on page open
    loadUsers();
  </script>
</body>
</html>
